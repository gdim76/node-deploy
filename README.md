# node-deploy

Ansible deploy script for Innochain node based on CakeML

## 1. Getting started

Перед началом работы необходимо установить:
[ansible 2.9.24](https://docs.ansible.com/ansible/latest/installation_guide/intro_installation.html#installing-ansible-on-specific-operating-systems)

```
$ sudo apt update
$ sudo apt install software-properties-common
$ sudo add-apt-repository --yes --update ppa:ansible/ansible
$ sudo apt install ansible
```

Затем нужно клонировать репозиторий node-deploy

```
git clone https://github.com/gdim76/node-deploy.git
```

Далее нужно внести изменения в файл hosts.
Группа `[managed_nodes]` состоит из описания машин на которых будут развёрнуты узлы. 
В файл необходим добавить IP адреса nodes.  
Для тестирования необходимо внести в файл connect_to_host.yml
список IP адресов nodes для распространния ssh ключей для подключения.

## 2. Подготовка Клонирование репозиториев node-ml и node-ml-api


## 3. Развёртывание узлов

Плейбук __deployment.yml__  подготовливает Nodes для развертывания.
hosts: all 
Role  Predeploy - создает папку в home директории и скачивает из репозиториев node-ml и node-ml-api 

git clone https://gitlab.com/InnoChain/node-ml.git
git clone https://gitlab.com/RIRussel/node-ml-api.git

Role Common и Gosts устанавливает необ

разворачивает узлы непосредственно на машинах.
По завершению развёртывания, узлы будут работать в виде сервисов с названием __ml-innochain.service__

Для запуска ансибл плейбука нужно перейти в директорию `node-deploy` 

```
ansible-playbook deployment.yml
```
Пример запуска плейбука с предоставлением файла хостов через флаг:

```
ansible-playbook deployment.yml -i hosts
```
Для остановки узлов на всех машинах можно воспользоваться плейбуком __ml-innochain-stop.yml__

```
ansible-playbook ml-innochain-stop.yml
```
Для последующих запусков можно использовать теги:  
__rebuild__ - полезен при изменении кода узла, с его помощью можно пересобрать и запустить узел.

```
ansible-playbook deployment.yml --tags rebuild
```
__restart__ - просто перезапускает узел.
```
ansible-playbook deployment.yml --tags restart
```
При необходимости отчистки базы данных можно воспользоваться флагом __clean_db__

```
ansible-playbook deployment.yml --tags restart -e clean_db=yes
```

## 4. Локальное развёртывание узлов в docker контейнерах

__Перед началом локального развертывания необходимо выполнить пункты 1 и 2.__  
Для запуска локального развёртывания нужно перейти в директорию `node-deploy` и выполнить следующую команду:

```
ansible-playbook local-deploy.yml
```

По завершении плейбук развернёт сеть из 4 узлов. Апи будет доступно на портах с __8000__ по __8003__
Файл `node.log` для каждого узла хранится в директории `node-deploy/temp` с цифрой соответствующей номеру узла например `node-deploy/temp1`  
По завершении чтения параметров, узел начнёт писать логи в __stdout__ докер контейнера. Просмотреть их можно при помощи команды `docker logs` с названием нужного контейнера или при помощи графаны.
Веб интерфейс для просмотра логов Grafana будет доступен на __3000__ порту. 

Для получения доступа к логам необходимо в меню, находящемся слева, нажать на значок шестерни __Configuration__ затем нажать на кнопку __Add data source__, в появившемся меню пролистать немного вниз и выбрать __Loki__
Теперь перед вами страница настройки источника данных, вам необходимо найти раздел с заголовком __HTTP__ и ввести в поле __url__ следующий адрес `loki_loki_1:3100` остальные поля менять не обязательно. По завершении настройки источника данных необходимо нажать кнопку __Save & Test__ при успешном добавлении источника вы увидите сообщение __Data source connected and labels found__. Теперь можно отправлять запросы через __Explore__, он находится в меню слева и выглядит как компас. Нажмите на компас, на появившейся странице сверху рядом с надписью __Explore__ в выпадающем меню выберите __Loki__ и начните вводить `{` в поле __Log browser__. Вы увидите подсказку и сможете выбрать и посмотреть доступные поля, выберите из списка __job__ появится новая подсказка в ней выберите __node1-node__ Справа сверху нажмите кнопку __Run query__ вам отобразятся логи узла под номером 1.

Команда для остановки и удаления контейнеров:

```
ansible-playbook local-deploy.yml --tags down
```
Существует несколько дополнительных тегов.
- up - создаёт и запускает контейнеры с образов.
- rebuild - пересобирает узел и innochain-cli, запускает контейнеры.
- stop - останавливает все докер контейнеры.
- start - запускает все докер контейнеры, после их остановки.
- clean - удаляет все директории temp
- reload_api - заново копирует апи, пересоздаёт `node.log` файлы и запускает контейнеры с образов

## 5. Глобальное развёртывание узлов в docker контейнерах

По завершении плейбук развернёт сеть из 4 узлов на машинах из группы managed_nodes. Апи будет доступно на __8000__ порте.
Файл `node.log` для каждого узла хранится в директории `~/node/node-ml/node.log` и содержит в себе лог чтения параметров командной строки.
По завершении чтения параметров, узел начнёт писать логи в __stdout__ докер контейнера. Просмотреть их можно при помощи команды `docker logs` с названием нужного контейнера или при помощи графаны.
Веб интерфейс для просмотра логов Grafana будет доступен на __3000__ порту, у каждого узла свой контейнер с графаной. 

Для запуска ансибл плейбука нужно перейти в директорию __node-deploy__ и выполнить следующую команду:

```
ansible-playbook docker-deploy.yml --tags initial_run
```

Для получения доступа к логам необходимо в меню, находящемся слева, нажать на значок шестерни Configuration затем нажать на кнопку __Add data source__, в появившемся меню пролистать немного вниз и выбрать __Loki__
Теперь перед вами страница настройки источника данных, вам необходимо найти раздел с заголовком __HTTP__ и ввести в поле __url__ следующий адрес `node_loki_1:3100` остальные поля менять не обязательно. По завершении настройки источника данных необходимо нажать кнопку __Save & Test__ при успешном добавлении источника вы увидите сообщение __Data source connected and labels found__. Теперь можно отправлять запросы через __Explore__, он находится в меню слева и выглядит как компас. Нажмите на компас, на появившейся странице сверху рядом с надписью __Explore__ в выпадающем меню выберите __Loki__ и начните вводить `{` в поле __Log browser__. Вы увидите подсказку и сможете выбрать и посмотреть доступные поля, выберите из списка __job__ появится новая подсказка в ней выберите __node1-node__ Справа сверху нажмите кнопку __Run query__ вам отобразятся логи узла под номером 1.

Команда для остановки и удаления контейнеров:

```
ansible-playbook docker-deploy.yml --tags down
```
Существует несколько дополнительных тегов.
- up - создаёт и запускает контейнеры с образов.
- rebuild - пересобирает узел и innochain-cli, запускает контейнеры.
- stop - останавливает все докер контейнеры.
- start - запускает все докер контейнеры, после их остановки.
- reload_api - заново копирует апи, пересоздаёт `node.log` файлы и запускает контейнеры с образов.

